@* @page "/chatmiembro/crear"
@inject IChatMemberServicio http
@inject NavigationManager navHttp
@inject HttpClient Http
<h3>Crear Chat Miembro</h3>


<EditForm Model="chatmember" OnValidSubmit="Grabar" FormName="CrearMiembroForm">
    <DataAnnotationsValidator />
    <ValidationSummary /> *@

    @*  <div class="form-group">
    <label>ChatId</label>
        <div>
        <InputNumber class="form-control" @bind-Value="chatmember.ChatId" />
        <ValidationMessage For="@(() => chatmember.ChatId)" />
        </div>
    </div> *@

    @* <div class="form-group">
        <label>UserId</label>
        <div>
            <InputNumber class="form-control" @bind-Value="chatmember.UserId" />
            <ValidationMessage For="@(() => chatmember.UserId)" />
        </div>
    </div>

    <div class="form-group">
        <label>IsModerator</label>
        <div>
            <InputCheckbox @bind-Value="chatmember.IsModerator" />
            <ValidationMessage For="@(() => chatmember.IsModerator)" />
        </div>
    </div>

    <div class="form-group">
        <label>CanWrite</label>
        <div>
            <InputCheckbox @bind-Value="chatmember.CanWrite" />
            <ValidationMessage For="@(() => chatmember.CanWrite)" />
        </div>
    </div> *@

    @* <div class="form-group">
        <label>Fecha de Creacion</label>
        <div>
        <InputDate class="form-control" @bind-Value="chatmember.JoinedAt" />
        <ValidationMessage For="@(() => chatmember.JoinedAt)" /> 
        </div>
    </div> *@

    @* <button class="btn btn-primary" type="submit">Aceptar</button>
    <button class="btn btn-primary" @onclick="Cancelar">Cancelar</button>
</EditForm> *@

@* <br />
<p>@Mensaje</p>

@code {

    private List<User> usuarios = new();

    protected override async Task OnInitializedAsync()
    {
        usuarios = await chatServicio.GetAsync<List<User>>("api/user");
    }

    private ChatMemberDTO chatmember = new ChatMemberDTO();
    string Mensaje = "";

    private async Task Grabar()
    {
        var respuesta = await http.Post<ChatMemberDTO, int>("api/ChatMember", chatmember);
        if (!respuesta.Error)
        {
            navHttp.NavigateTo("/chatmiembro");
        }
        else
        {
            //var body = await respuesta.HttpResponseMessage.Content.ReadAsStringAsync();
            Mensaje = respuesta.OptenerError();
        }
    }

    // private async Task Editar()
    // {
    //     var respuesta = await http.Put<ChatMemberDTO, int>("api/ChatMember", chatmember);
    //     if (!respuesta.Error)
    //     {
    //         navHttp.NavigateTo("/chatmiembro");
    //     }
    //     else
    //     {
    //         //var body = await respuesta.HttpResponseMessage.Content.ReadAsStringAsync();
    //         Mensaje = respuesta.OptenerError();
    //     }
    // }

    private async Task Cancelar()
    {
        navHttp.NavigateTo("/chatmiembro");
    } 
}*@

@page "/chatmiembro/crear"
@inject HttpClient Http
@inject NavigationManager navHttp

<h3>Crear Grupo</h3>

<div class="form-group">
    <label>Nombre del grupo</label>
    <input class="form-control" @bind="nombreGrupo" />
</div>

<h5 class="mt-3">Seleccionar usuarios</h5>

@if (usuarios == null)
{
    <p>Cargando usuarios...</p>
}
else
{
    @foreach (var u in usuarios)
    {
        <div class="form-check">
            <input type="checkbox" class="form-check-input" @bind="u.Seleccionado" />
            <label class="form-check-label">
                @u.FirstName @u.LastName
            </label>
        </div>
    }
}

<button class="btn btn-success mt-3" @onclick="CrearGrupo">Crear grupo</button>
<button class="btn btn-secondary mt-3" @onclick="Cancelar">Cancelar</button>

<p class="text-danger">@Mensaje</p>

@code {

    public class UsuarioSeleccionVM
    {
        public long Id { get; set; }
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public bool Seleccionado { get; set; }
    }


    private string nombreGrupo = "";
    private string Mensaje = "";

    private List<UsuarioSeleccionVM> usuarios = new();

    protected override async Task OnInitializedAsync()
    {
        var lista = await Http.GetFromJsonAsync<List<ListaUsuarioDTO>>("api/Usuario");

        usuarios = lista.Select(u => new UsuarioSeleccionVM
        {
            Id = u.Id,
            FirstName = u.FirstName ?? "",
            LastName = u.LastName ?? ""
        }).ToList();
    }

    private async Task CrearGrupo()
    {
        var seleccionados = usuarios
            .Where(u => u.Seleccionado)
            .Select(u => u.Id)
            .ToList();

        if (!seleccionados.Any())
        {
            Mensaje = "Debes seleccionar al menos un usuario";
            return;
        }

        // Crear el chat primero
        var chat = new
        {
            Name = nombreGrupo,
            IsGroup = true
        };

        var chatResponse = await Http.PostAsJsonAsync("api/chat", chat);

        if (!chatResponse.IsSuccessStatusCode)
        {
            Mensaje = "Error al crear el chat del grupo";
            return;
        }

        var nuevoChat = await chatResponse.Content.ReadFromJsonAsync<Chat>();

        // Crear los miembros del grupo
        foreach (var userId in seleccionados)
        {
            var miembro = new ChatMemberDTO
            {
                ChatId = nuevoChat.Id,
                UserId = userId,
                IsModerator = false,
                CanWrite = true
            };

            await Http.PostAsJsonAsync("api/ChatMember", miembro);
        }

        navHttp.NavigateTo("/chat-sidebar");
    }

    private void Cancelar()
    {
        navHttp.NavigateTo("/chat-sidebar");
    }
}
