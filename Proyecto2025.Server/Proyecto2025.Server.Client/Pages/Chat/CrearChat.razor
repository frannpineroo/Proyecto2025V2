@* @page "/chat/crear"
@inject IChatServicio http
@inject NavigationManager navHttp
@inject HttpClient Http
<h3>Crear Chat</h3>


<EditForm Model="chat" OnValidSubmit="Grabar" FormName="CrearChatForm">

    <DataAnnotationsValidator />
    <ValidationSummary />

    @* <div class="form-group">
        <label>Id</label>
        <div>
        <InputNumber class="form-control" @bind-Value="chat.Id" />
        <ValidationMessage For="@(() => chat.Id)" />
        </div>
    </div> *@

    @* <div class="form-group">
        <label>Name</label>
        <div>
            <InputText class="form-control" @bind-Value="chat.Name" />
            <ValidationMessage For="@(() => chat.Name)" />
        </div>
    </div>

    <div class="form-group">
        <label>IsGroup</label>
        <div>
            <InputCheckbox @bind-Value="chat.IsGroup" />
            <ValidationMessage For="@(() => chat.IsGroup)" />
        </div>
    </div>

    <div class="form-group">
        <label>IsModerated</label>
        <div>
            <InputCheckbox @bind-Value="chat.IsModerated" />
            <ValidationMessage For="@(() => chat.IsModerated)" />
        </div>
    </div> *@

    @* <div class="form-group">
        <label>CreatedAt</label>
        <div>
        <InputDate class="form-control" @bind-Value="chat.CreatedAt" />
        <ValidationMessage For="@(() => chat.CreatedAt)" />
        </div>
    </div> *@

    @* <div class="form-group">
        <label>UpdatedAt</label>
        <div>
        <InputDate class="form-control" @bind-Value="chat.UpdatedAt" />
        <ValidationMessage For="@(() => chat.UpdatedAt)" />
        </div>
    </div> 

    <button class="btn btn-primary" type="submit">Aceptar</button>
    <button class="btn btn-primary" @onclick="Cancelar">Cancelar</button>
</EditForm>

<br />
<p>@Mensaje</p>

@code {


    private ChatDTO chat = new ChatDTO();
    string Mensaje = "";

    private async Task Grabar()
    {
        var respuesta = await http.Post<ChatDTO, long>("api/chat", chat);
        if (!respuesta.Error)
        {
            navHttp.NavigateTo("/Principal");
        }
        else
        {
            //var body = await respuesta.HttpResponseMessage.Content.ReadAsStringAsync();
            Mensaje = respuesta.OptenerError();
        }
    }

    private async Task Cancelar()
    {
        navHttp.NavigateTo("/chat-sidebar");
    }
} *@

@page "/chat/crear"
@inject IChatServicio http
@inject NavigationManager navHttp
@inject HttpClient Http

<h3>Crear Chat</h3>

<EditForm Model="chat" OnValidSubmit="Grabar">
    <DataAnnotationsValidator />
    <ValidationSummary />
<div class="form-group">
    <label>Seleccionar Usuario</label>
    <select class="form-control" @bind="usuarioSeleccionadoId">
        <option value="0">-- Seleccionar usuario --</option>

        @foreach (var u in usuarios)
        {
            <option value="@u.Id">
                @u.FirstName @u.LastName
            </option>
        }
    </select>
</div>

<div class="form-group mt-2">
    <label>Nombre del Chat</label>
    <input class="form-control" @bind="chat.Name" readonly />
</div>

<div class="form-group mt-2">
    <label>Tipo de Chat</label>
    <div>
        <InputCheckbox @bind-Value="chat.IsGroup" />
        <span> Es chat grupal</span>
    </div>
</div>

<div class="form-group mt-2">
    <label>Moderado</label>
    <div>
        <InputCheckbox @bind-Value="chat.IsModerated" />
    </div>
</div>
    
<button class="btn btn-primary mt-3" @onclick="Grabar">Crear Chat</button>
<button class="btn btn-secondary mt-3" @onclick="Cancelar">Cancelar</button>
</EditForm>


<p class="mt-3">@Mensaje</p>

@code {

    private ChatDTO chat = new ChatDTO();
    private string Mensaje = "";

    private long _usuarioSeleccionadoId;
    private long usuarioSeleccionadoId
    {
        get => _usuarioSeleccionadoId;
        set
        {
            _usuarioSeleccionadoId = value;

            var user = usuarios.FirstOrDefault(x => x.Id == value);
            if (user != null)
            {
                chat.Name = $"{user.FirstName} {user.LastName}";
            }
        }
    }

    private List<ListaUsuarioDTO> usuarios = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<ListaUsuarioDTO>>("api/Usuario");
            if (result != null)
            {
                usuarios = result;
            }
        }
        catch
        {
            Mensaje = "Error al cargar usuarios";
        }
    }

    private async Task Grabar()
    {
        try
        {
            var respuesta = await http.Post<ChatDTO, ListaChatDTO>("api/Chat", chat);

            if (!respuesta.Error)
            {
                Mensaje = " Chat creado correctamente";
                navHttp.NavigateTo("/chat-sidebar");
            }
            else
            {
                Mensaje = " Error al crear el chat: " + respuesta.OptenerError();
            }
        }
        catch (Exception ex)
        {
            Mensaje = " Error inesperado: " + ex.Message;
        }
    }

    private void Cancelar()
    {
        navHttp.NavigateTo("/chat-sidebar");
    }
}

