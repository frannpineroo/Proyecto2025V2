@* <div class="chat-window">
    <div class="chat-header">
        <div class="header-info">
            <div class="avatar large">LM</div>
            <div>
                <h4>Laura Martínez</h4>
                <p class="status">En línea</p>
            </div>
        </div>
        
    </div>

    <div class="chat-messages">
        <VistaMensaje Sender="Laura Martínez" Text="Hola! ¿Cómo va el avance del proyecto?" Time="10:30" />
        <VistaMensaje IsOwn="true" Text="¡Hola Laura! Estamos avanzando bien, ya terminamos la primera fase del diseño." Time="10:32" />
        <VistaMensaje Sender="Laura Martínez" Text="¡Excelente! ¿Podrías compartirme los mockups cuando estén listos?" Time="10:35" />
        <VistaMensaje IsOwn="true" Text="Claro, los tendremos listos para mañana. Te los envío apenas estén terminados." Time="10:38" />
        <VistaMensaje Sender="Laura Martínez" Text="Perfecto, gracias! También necesitaríamos una reunión con el equipo para revisar los avances. ¿Te parece bien el jueves?" Time="10:40" />
        <VistaMensaje IsOwn="true" Text="El jueves me parece bien. ¿A qué hora les conviene?" Time="10:42" />
    </div>

    <EscribirMensaje />
</div>

<style>
 .chat-window {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #fff;
    border-bottom: 1px solid #ddd;
}
.header-info {
    display: flex;
    align-items: center;
}
.avatar.large {
    width: 45px;
    height: 45px;
    margin-right: 10px;
}
.status {
    color: #2ecc71;
    font-size: 12px;
}
.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background-color: #fafafa;
}
.icon-btn {
    background: none;
    border: none;
    font-size: 18px;
    margin-left: 10px;
    cursor: pointer;
}
</style>

@code {

} *@
@* @using Proyecto2025.Server.Client.Pages.Chat 
@inject IChatServicio chatServicio
<div class="chat-window">
    @if (selectedChatId == 0)
    {
        <div style="padding:20px;color:#777;">
            Seleccioná un chat para ver los mensajes
        </div>
    }
    else
    {
        <div class="chat-header">
            <div class="header-info">
                <div class="avatar large">@ChatIniciales</div>
                <div>
                    <h4>@ChatNombre</h4>
                    <p class="status">En línea</p>
                </div>
            </div>
        </div>

        <div class="chat-messages">
            @if (Mensajes == null || Mensajes.Count == 0)
            {
                <div style="color:#999;">No hay mensajes en este chat</div>
            }
            else
            {
                @foreach (var m in Mensajes)
                {
                    <VistaMensaje IsOwn="@(m.SenderId == UsuarioActualId)"
                                  Sender="@m.SenderName"
                                  Text="@m.Content"
                                  Time="@m.SentAt.ToString("HH:mm")" />
                }
            }
        </div>
        <div class="chat-input">
            <input class="form-control"
                   placeholder="Escribí un mensaje..."
                   @bind="NuevoTexto" />

            <button class="btn btn-primary" @onclick="EnviarMensaje">
                Enviar
            </button>
        </div>
        <EscribirMensaje OnSend="EnviarMensaje" />
    }
</div>


@code
{
    private string NuevoTexto = "";
    private List<VerMensajesDTO> Mensajes = new();
    private long UsuarioActualId = 1; // cambialo por el usuario logueado
    private long selectedChatId = 0;
    private List<ListaChatDTO> Chats = new();


    private string ChatNombre = "";
    private string ChatIniciales = "";

    private async Task CargarMensajes(long chatId)
    {
        var r = await chatServicio
            .GetEsAsync<List<VerMensajesDTO>>($"api/mensaje/{chatId}");

        if (!r.Error && r.Respuesta != null)
            Mensajes = r.Respuesta;
        else
            Mensajes = new();
    }

    private async Task EnterChat(long chatId)
    {
        selectedChatId = chatId;

        var chat = Chats.FirstOrDefault(c => c.Id == chatId);
        if (chat != null)
        {
            ChatNombre = chat.Name;
            ChatIniciales = GetInitials(chat.Name);
        }

        await CargarMensajes(chatId);
    }


    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";

        var parts = name.Split(' ');
        if (parts.Length == 1)
            return parts[0][0].ToString();

        return string.Concat(parts[0][0], parts[1][0]);
    }


    private CrearMensajeDTO NuevoMensaje = new();

    private async Task EnviarMensaje()
    {
        if (selectedChatId == 0 || string.IsNullOrWhiteSpace(NuevoTexto))
            return;
        var dto = new CrearMensajeDTO
            {
                ChatId = selectedChatId,
                SenderId = UsuarioActualId,
                Content = NuevoTexto,
                SentAt = DateTime.UtcNow,
            };
        await chatServicio.Post<CrearMensajeDTO, object>("api/mensaje", NuevoMensaje);

        NuevoTexto = "";

        await CargarMensajes(selectedChatId);
    }


} *@

@using Proyecto2025.Shared.DTO
@inject IChatServicio chatServicio

<div class="message-panel">
    @if (SelectedChatId == 0)
    {
        <div class="empty-chat">
            <p>Seleccioná un chat para ver los mensajes</p>
        </div>
    }
    else
    {
        <div class="messages-container">
            @foreach (var m in Mensajes)
            {
                <div class="message-bubble">
                    <b>@m.SenderName</b>
                    <p>@m.Content</p>
                    <small>@m.SentAt.ToString("HH:mm")</small>
                </div>
            }
        </div>

        <div class="chat-input">
            <input placeholder="Escribe un mensaje..."
                   @bind="nuevo.Content" />

            <button @onclick="EnviarMensaje">Enviar</button>
        </div>
    }
</div>

@code {
    private long SelectedChatId;
    private List<VerMensajesDTO> Mensajes = new();
    private CrearMensajeDTO nuevo = new();

    public async Task Load(long chatId)
    {
        SelectedChatId = chatId;

        var r = await chatServicio
            .GetEsAsync<List<VerMensajesDTO>>($"api/message/chat/{chatId}");

        if (!r.Error && r.Respuesta != null)
            Mensajes = r.Respuesta;
        StateHasChanged();
    }

    private async Task EnviarMensaje()
    {
        if (SelectedChatId == 0) return;

        nuevo.ChatId = SelectedChatId;
        nuevo.SenderId = 1;

        await chatServicio.Post<CrearMensajeDTO, object>("api/message", nuevo);

        nuevo.Content = "";

        await Load(SelectedChatId);
    }
}
